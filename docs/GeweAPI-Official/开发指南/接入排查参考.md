# 接入排查参考

:::danger
**说明：** 新注册账号/未实名账号/被封过的账号属于低质量账号，请勿在本平台使用！先确保账号已实名且正常使用方可接入平台
:::

<Accordion title="掉线问题排查"defaultOpen={false} >
**目前新用户登录API平台，24小时内首夜会100%掉线，掉线后传appId调用获取二维码接口再次扫码登录即可实现3月内不掉线，目前已知会导致微信掉线的情况有：**
**可能性1：** 微信登录地点是异省，则必然出现秒掉，且每次登陆都会掉线(需使用本省代理)，若使用本省代理方式登录，且登录也出现60秒内掉线，且传appId再次取码登录依然秒掉，则进入新设备风控，第二天8点后必然可以正常登录使用。
**可能性2：** 微信登录IPad真机或者手机退出微信或者换了手机登录微信，导致挤掉线
**可能性3：** 登录本平台未满2天的微信属于非安全环境，非安全环境下禁止频繁触发敏感行为（群发同质化内容、添加好友,自动同意好友、创建群聊，入群）等，容易触发各类异常风控，建议在线1~2天后在做频繁操作。
**可能性4：** 首夜掉线后一定记得**传appId获取二维码扫码**登录，这样才会登录上次登录的设备，否则就会循环陷入掉线的情况（严重者则封号），判断是否陷入循环掉线，可在手机微信 设置-账号与安全-登录过的设备 查看，**如果存在多个ipad开头的即代表是错误的**
 </Accordion>



<Accordion title="发送消息的注意点" defaultOpen={false}>
**核心：** 尽量像人为在操作。
1. **消息发送频率建议**
1min建议40条左右，每个不同用户切换间隔1S，不同群发送间隔随机2-5S，消息需走队列形式。

2. **为什么消息发送失败**
**可能性1：** 小程序消息每日会有条数限制（WeChat规范限制）
**可能性2：** 发送对象不存在/群被踢出/好友被删除等
**可能性3：** 消息发送过快导致，手机会显示发送频率过快请稍后重试
**可能性4：** 消息发送不能存在并发，必须走消息队列消费发送（一个调用发送成功后，在调用下一个事件消费）

3. **为什么群消息有的人看不见**
在腾讯内部规则中，发送同质化内容过多，或者疑似营销内容以及发送量快会导致此问题，会降权此条消息内容有效到达数，随机性推送可看到的用户，可用手机测试

4. **为什么图片/视频/文件消息发送慢**
图片/视频/文件的服务器的速度会导致此问题，发送图片/视频/文件接口的原理是我们将资源的url下载我们服务器中然后在转换成认可的资源发送，可以多通过网络图片测试对比是否是是图片服务器慢的问题。

5. **很多个微信发送同样内容或单个微信同样内容发送给很多好友的优化方式？**
**说明：** 本场景多适用于云发单及社群机器人，如若1000个微信需要发单，不要直接调用发送图片/视频/文件接口（直接发送会每张微信都上传图片/视频/文件，重复消耗流量，占用网速），如下所示，有以下3种解决优化方案：
**第一种方案：** 找2个机器人创建个素材群（素材机器人+素材接收机器人），把图片/视频/文件让素材机器人发送接口发到素材群，素材接收机器人会收到图片/视频/文件的XML，后续直接让发单机器人根据xml调用转发图片/视频消息接口即可（转发接口无上传操作，效率提升几十倍），不限制发单机器人是否在群内，有xml就可以发。
**第二种方案：** 先把文件/图片/视频发送至额外的机器人，通过消息回调获取文件消息的 xml 后，使用转发文件/图片/视频接口发送（转发接口无上传操作，效率提升几十倍）
**第三种方案：** 发送相同的图片的话，随便找1个微信直接调用CDN图片/视频上传接口，拿到返回秘钥，其他微信就不调用上传接口，而是直接调用转发接口（上传图片的微信和直接使用转发接口的微信可以毫无关系）动态组装下转发接口xml就可发送（转发接口无上传操作，效率提升几十倍）
</Accordion>

<Accordion title="消息接收问题排查" defaultOpen={false}>
**1.消息接收慢**
**可能性一：** 用户接口的死锁，堵塞，多线程处理错乱，接口业务处理消息时间过长会导致此问题，具体开发者可以自行使用postman测试下自己接口或者登录后台系统查看回调是否正常
**可能性二：** 在腾讯内部规则中，发送同质化内容过多，群过多，群消息过多，或者疑似营销内容以及发送量快会导致此问题，会降权此条消息内容有效到达数，随机性推送可看到的用户，可用手机测试是否正常。或者以多个机器人微信作为协助。
    
 **2.消息接收不到**
**排查一：** 首先开发者需确认提供的服务器接口是可以通的，微信的消息回调会以post请求 json参数的格式请求开发者服务器接口。开发者也可以使用postman测试下自己接口是否正常
**排查二：** 开发者需确认微信没被踢掉线，确认是否在线是 以调用发送文本消息接口或者查询微信是否在线接口成功为准，注意：通过接口发送的消息不会有回调
</Accordion>


<Accordion title="主被动添加类问题" defaultOpen={false}>
**1.添加好友接口调用规则**
    24 小时只能加 5-15 位好友，每 2 小时不要超过 8 人，每个好友添加间隔要做随机间隔，否则添加了对方，显示发送验证成功，对方也收不到你的验证信息。（新登录平台的微信需在线3天调用本接口）

**2.同意好友接口调用规则**
     根据微信号权重，微信每天被动通过好友数不要超过 200 人，过多扫二维码添加也有封 号风险，并且一天太多人添加，你的微信将收不到别人的验证消息。

**3.搜索好友调用规则**
      搜索好友数量每日大概在10-20之间，具体可手机，调用需做好间隔。
    
**4.如何获取群内非好友的微信号**
微信新规，无法查看微信号
</Accordion>

<Accordion title="群相关问题" defaultOpen={false}>
**1.为什么接口返回的群少了或者没有**
 接口一次性是获取不是全部的群，仅会获取保存到通讯录的群，当有未获取的群有人在群内发消息的话会有消息回调， 开发者此刻调用获取群详情接口 再保存到自己数据库中就取到了，比如说手机上三年前不说话的群，侧滑删除了，然后你换了手机也不会取到的 ，有人说了话他才会置顶，原理就是各个终端（Android、IOS、桌面版微信）取得了消息回调，又去获取群了详情 本地数据库缓存了下来 更新的ui，让用户感知的。
**2.创建群聊规范**
每天只能添加10个群，频率间隔在10分钟以上。如果建群数量超出， 或者频率过快，就会返回失败，具体可根据微信号适当增减。
**3.获取群二维码接口扫描显示已过期**
 新登录API平台的微信用户需在线3天后调用获取群二维码，此时群二维码才可以正常使用。
</Accordion>

<Accordion title="朋友圈问题" defaultOpen={false}>
**1.朋友圈接口调用规则**
获取动态接口建议最低间隔5S/次，一天不要超过200次
点赞评论接口建议间隔随机3-10s/次，一天不要超过500条
**2.发送朋友圈为什么返回失败**
 新登录API平台的微信用户需在线1天后才可正常发送朋友圈
**3.发送朋友圈/评论自己看得到，别人看不到**
**可能一：** 朋友圈或者评论发多了或导致此问题，腾讯选择性推送
**可能二：** 某些屏蔽的关键字也会导致此问题（比如淘客行业的评论文字，原文字会被拦截屏蔽，需开发者修改下部分文字去适配）
**可能三：** 图片内容或者文字违法违规
</Accordion>

<Accordion title="下载问题" defaultOpen={false}>
 **1.下载接口调用规则**
下载必须要设置下载队列，每条消息的下载要与上条间隔3-10S（随机time）
一条消息只下载一次
**2.下载接口为什么返回失败**
无论是下载图片、语音、链接、视频、假如频繁下载皆有可能导致此问题，我们对于这类建议如下：适配调用规则，千万别收到消息就下载！！！，否则容易失败甚至被踢掉线，一定要做下载队列，假如觉得下载时间太长业务不满足，可以多放几个僵尸微信/转发图片到其他机器人再做下载使用 
**文件下载失败：** 除了上述频率问题，还有可能是因为回调有两条，开发者应选择第二条下载
**图片下载失败：** 除了上述频率问题，图片下载失败有可能不存在普清/高清，需重试几次其他种类
</Accordion>

<Accordion title="微信号显示问题" defaultOpen={false}>
在调用获取通讯录信息接口中，微信原始id有时候返回是手机上的微信号，也有的是没有微信号，仅有wxid开头的，导致开发者有点混乱，其实这是微信的内部规则，微信原始id就是获取通讯录接口返回的，alisname为空，则代表该微信没有微信号，仅有wxid，具体理解下如图即可。

|  序号	| 微信原始id | 微信号 | 接口wxid返回|描述|
| --- | --- |--- |--- |--- |
|1|	wxid_7092880929211|	空	|wxid_7092880929211	|该帐号注册时用了微信默认提供的微信号,目前还没有自定义wx_alias,因此该账号每年都有1次自定义wx_alias的机会
2|	wxid_hrtv4z7etgvc22|	fangqing0827	|wxid_hrtv4z7etgvc22	|该帐号注册时用了微信系统默认提供的微信号,后来又自定义wx_alias为fangqing0827
3|	qq526552198	|空|	qq526552198|	帐号注册时用了自定义的微信号,所以没有机会自定义wx_alias了,因此wx_alias一直为空
4|	fangqing_hust|	heiheizwx|	fangqing_hust	|该帐号最初是用QQ注册的(现在已经不允许这种方式注册了),后来自定义了wx_alias为heiheizwx
5|	gh_7ec28ec1ef37	|jueduixiao888|	gh_7ec28ec1ef37	|普通的公众号wxid以gh开头
6|	Tencent-Games	|空|	Tencent-Games|	腾讯自家的公众号wxid不以gh_开头
</Accordion>

<Accordion title="此条必看" defaultOpen={false}>
**敏感类接口：** 添加好友、同意好友、获取群二维码、创建群聊为敏感接口，建议非异地登录且安全环境下再做操作，否则会有一定几率风控，目前部分敏感接口已需强制在线几天，方可操作接口
**安全环境：** 登录未满48小时属于非安全环境，一般新用户微信登录24小时内会掉线一次，传appid取码登录后再隔一天就属于安全环境。
**异地登录：** 扫码登录显示其他城市，可使用本地代理登录解决/私有化部署本地服务。
严格按照本调用规范手册则可避免99.99%技术风控，但部分敏感行为操作仍会导致使用规范风控，常见敏感行为：（异地环境下/非安全设备环境下添加好友和自动同意好友，群发内容、拉群及图片违法违规，接口使用间隔频率像机器人等）
目前部分敏感接口已需要强制在线几天方可使用，规则如下：
获取群二维码接口3天 （官方限制）
发送朋友圈类接口1天  （官方限制）
获取群二维码接口3天（官方限制）
 </Accordion>




